# yt-dlp-ui 开发交接记录（2026-02-27）

## 1. 本轮目标与完成情况

### 用户目标
基于 `https://github.com/yt-dlp/yt-dlp` 做一个带 UI 的本地下载工具，并持续增强。

### 已完成（按迭代顺序）
1. 从基础 Flask 版升级为可用 UI 下载器（解析信息、格式选择、实时日志/进度、任务历史、取消任务）。
2. 增加批量队列下载：支持一次提交多 URL，队列顺序执行。
3. 增加失败自动重试与手动重排队。
4. 增加下载完成通知与一键打开输出目录。
5. 增加每任务重试策略覆盖：
   - 固定间隔 `fixed`
   - 指数退避 `exponential`
   - 基础重试延迟（秒）
   - 最大退避延迟（秒）
6. 增加代理池重试轮换：
   - 每任务可配置多代理（每行一个）
   - 失败后重试时自动轮换到下一个代理
   - 有代理池时会覆盖 `extra_args` 中的 `--proxy`
7. 增加下载完成自动打开目录（可选开关）：
   - 每任务可设置 `auto_open_output`
   - 下载成功后自动调用本地文件管理器打开输出目录
   - 自动打开失败仅记日志，不影响任务成功状态
8. 增加一键启动脚本：
   - 新增 `start.sh`，自动准备环境并启动服务
   - 支持 `--check`（仅检查环境）与 `--no-browser`（不自动打开浏览器）

## 2. 关键实现点

### 后端（`app.py`）
- 任务模型：`DownloadJob`
  - 关键字段：`retry_max`、`retry_count`、`retry_strategy`、`retry_delay_seconds`、`retry_max_delay_seconds`
  - 自动打开字段：`auto_open_output`
  - 代理字段：`proxy_pool`、`proxy_index`、`active_proxy`
- 队列执行：`JOB_QUEUE` + 单 worker 顺序下载
- 自动重试：`schedule_retry()` + `compute_retry_delay_seconds()`
- 自动打开目录：`run_download()` 成功后按开关触发 `open_output_path()`
- 代理池轮换：`current_proxy()` + `schedule_retry()` 内轮换代理索引
- 解析接口代理复用：`/api/info` 可读取代理池并使用第一个代理解析
- 新增任务级自动开目录字段：`auto_open_output`
- 新增接口：
  - `POST /api/jobs/<job_id>/requeue` 重排队
  - `POST /api/jobs/<job_id>/open-output` 打开输出目录
- 已有接口继续可用：
  - `POST /api/info`
  - `POST /api/download`
  - `GET /api/jobs`
  - `GET /api/jobs/<job_id>`
  - `POST /api/jobs/<job_id>/cancel`

### 前端（`templates/index.html`）
- 配置区新增重试策略配置（次数、策略、延迟）
- 配置区新增代理池输入（每行一个代理）
- 配置区新增“下载完成自动打开目录”开关
- 状态区新增“重试策略”展示
- 状态区新增“代理”展示（当前/下次代理）
- 任务列表中展示重试标签（`fixed:Ns` / `exp:Ns`）
- 任务列表中展示代理轮换标签（`p:x/y`）
- 新增按钮：
  - 重排队当前任务
  - 打开输出目录
- 下载完成浏览器通知（需授权）

### 启动脚本（`start.sh`）
- 自动创建 `.venv`（首次）
- 自动按 `requirements.txt` 哈希安装/更新依赖
- 自动补装 `yt-dlp`（若系统与虚拟环境都不存在）
- 默认自动打开 `http://127.0.0.1:17800`
- 参数：`--check` / `--no-browser`

### 样式（`static/style.css`）
- 新增 `inline-fields-3` 三列布局，用于重试策略配置区域。

## 3. 已验证结果

1. Python 语法：`python3 -m py_compile app.py` 通过。
2. 前端脚本语法：`js-ok`。
3. 批量队列：一次提交多链接，返回 `job_ids`，顺序执行。
4. 自动重试：
   - 固定间隔示例：2s -> 2s
   - 指数退避示例：1s -> 2s -> 4s（受 max delay 限制）
5. `requeue` 与 `open-output` API 均已实测成功。
6. 代理池行为验证：
   - 同时存在代理池与 `extra_args --proxy` 时，命令行使用代理池当前代理。
   - 重试后代理索引可从 `1 -> 2 -> ...` 轮换。
7. 自动打开目录行为验证：
   - 开关开启时，任务下载完成后自动打开输出目录。
   - 开关关闭时，不会自动触发打开目录。
8. 一键启动脚本验证：
   - `./start.sh --check` 可通过环境检查。
   - `./start.sh --no-browser` 可正常启动 Flask 服务。

## 4. 本地运行方式

```bash
cd /home/ghost/yt-dlp-ui
source .venv/bin/activate
python app.py
```

浏览器访问：`http://127.0.0.1:17800`

## 5. 当前可继续的下一步建议

1. 失败类型识别（网络/权限/格式）并给出分类型建议。
2. 导出任务记录（JSON/CSV）。

## 6. 聊天与协作摘要（压缩版）

- 用户先要求“建立带 UI 的 yt-dlp”。
- 基础版可用后，用户要求继续：
  - 批量队列下载（已完成）
  - 1/2 两项迭代（自动重试重排队 + 通知和打开目录，已完成）
  - 指数退避和任务级策略覆盖（已完成）
- 当前状态：功能稳定、可继续在此版本上迭代。

---

如果下一次继续，请优先从“失败类型识别（网络/权限/格式）”开始。
